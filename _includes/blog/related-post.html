{% assign maxRelated = 4 %}
{% assign minCommonTags = 1 %}
{% assign maxRelatedCounter = 0 %}
{% assign relatedPostsFound = false %}
{% assign relatedPosts = "" %}

{% for post in site.posts %}
  {% assign sameTagCount = 0 %}
  {% for tag in post.tags %}
    {% if post.url != page.url and page.tags contains tag %}
      {% assign sameTagCount = sameTagCount | plus: 1 %}
    {% endif %}
  {% endfor %}
  {% if sameTagCount >= minCommonTags %}
    {% assign relatedPostsFound = true %}
    {% capture relatedPost %}
      <a href="{{ site.baseurl }}{{ post.url }}">
        <div class="rel">
          <h5>{{ post.title }}</h5>
          {% if post.image or post.external-image %}
            {% include blog/related-post-image.html external-image=post.external-image image=post.image alt=post.image-alt %}
          {% endif %}
        </div>
      </a>
    {% endcapture %}
    {% assign relatedPosts = relatedPosts | append: relatedPost %}
    {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
    {% if maxRelatedCounter >= maxRelated %}
      {% break %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if relatedPostsFound %}
  <h2>Related Post</h2>
  <div class="rect">
    {{ relatedPosts }}
  </div>
{% endif %}
